@model Models.Print_GenkaModel
@{
    ViewBag.Title = "Print_Genka";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string loginUser = Session["UserInfo"].ToString();
    string LoginID = string.Empty;

    if (!string.IsNullOrEmpty(loginUser))
    {
        LoginID = loginUser.Split('_')[0].ToString();
    }

}

<style>
    #tblExcel tr th, #tblExcel tr td {
        border: 1px solid #808080;
    }

        #tblExcel tr th:first-child {
            width: 550px;
        }

        #tblExcel tr td:first-child {
            width: 50px;
        }

        #tblExcel tr td:nth-child(2) {
            width: 300px;
        }

        #tblExcel tr td:nth-child(3) {
            width: 200px;
        }

    #tblExcel tr th, #tblExcel tr td {
        width: 100px;
    }
</style>

@section Styles{
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Content/bootstrap-textbox.css")" />
}
<div id="divMain" class="container-fluid">
    <div class="content">
        <div class="p-5 row shadow" style="box-shadow: 0 .1rem .4rem rgba(0,0,0,.1) !important; background:white; border-radius:5px;">
            <div class="col-xs-12 col-md-4"></div>
            <div class="col-xs-12 col-md-5">
                <div>
                    <h2 class=" hr-text text-center">原価集計表</h2>
                </div>
                <div class="pt-3 md-form" style="padding-top:1.2rem!important;">
                    <div class="col-xs-12">
                        <div class="text-s text-custom1 text-uppercase mb-1">
                            <input type="text" tabindex="1" class="text-line col-xl-4 text-left" id="targetyear" onkeydown="KeyDown(event,this)" maxlength="4" placeholder="対象年度">
                        </div>
                    </div>
                </div>
                <div class="pt-3 md-form" style="padding-top:1.2rem!important;">
                    <div class="col-xs-12">
                        <div class="text-s text-custom1 text-uppercase mb-1">
                            <input type="text" tabindex="2" class="text-line col-xl-5 text-left" id="BrandCD" name="brandcd" onkeydown="KeyDown(event,this,'BrandCheck')" maxlength="6" style="width:140px;" placeholder="ブランド名">
                            <label id="brandname"><b>ブランド表示</b></label>
                        </div>
                    </div>
                </div>
                <div class="pt-3 md-form" style="padding-top:1.2rem!important;">
                    <div class="col-xs-12">
                        <div id="Seasongp" class="text-s text-custom1 text-uppercase mb-1">
                            <label id="text" style="padding-right:20px;">シーズン</label>
                            <input type="checkbox" tabindex="3" id="allyear" name="chk" value="1" onkeydown="KeyDown(event,this)" checked>
                            <label for="allyear" style="padding-right:20px!important;">通年</label>
                            <input type="checkbox" tabindex="4" id="SS" name="chk" value="2" onkeydown="KeyDown(event,this)" checked>
                            <label for="SS" style="padding-right:20px!important;">SS</label>
                            <input type="checkbox" tabindex="5" id="FW" name="chk" value="3" onkeydown="KeyDown(event,this,'SeasonCheck')" checked>
                            <label for="FW" style="padding-right:20px!important;">FW</label>
                        </div>
                    </div>
                </div>
                <div class="pt-3 md-form" style="padding-top:1.2rem!important;">
                    <div class="col-xs-12">
                        <div class="text-s text-custom1 text-uppercase mb-1">
                            <label id="text" style="padding-right:20px;">プロジェクト</label>
                            <input type="text" tabindex="6" class="text-line col-xl-3 text-left" id="ProjectCD" name="projectcd" onkeydown="KeyDown(event,this)" maxlength="10" required placeholder="入力">
                        </div>
                    </div>
                </div>
                <div class="pt-3 md-form" style="padding-top:1.2rem!important;">
                    <div class="col-xs-12">
                        <div class="text-s text-custom1 text-uppercase mb-1">
                            <label id="text" style="padding-right:116px;"></label>
                            <input type="text" id="projectName" tabindex="7" class="text-line col-xl-8 text-left" onkeydown="KeyDown(event,this)" required placeholder="入力" maxlength="60">
                        </div>
                    </div>
                </div>
                <div class="pt-3 md-form" style="padding-top:1.2rem!important;">
                    <div class="col-xs-12">
                        <div class="text-s text-custom1 text-uppercase mb-1">
                            <label id="text" style="padding-right:20px;">納品状況</label>
                            <input type="checkbox" tabindex="8" id="deliver" name="chk" onkeydown="KeyDown(event,this)" checked>
                            <label for="deliver" style="padding-right:20px!important;">納品残あり</label>
                            <input type="checkbox" tabindex="9" id="undeliver" name="chk" onkeydown="KeyDown(event,this,'flgCheck')">
                            <label for="undeliver" style="padding-right:20px!important;">完納</label>
                        </div>
                    </div>
                </div>
                <div class="pt-3 md-form" style="padding-top:1.2rem!important;">
                    <div class="col-xs-12" style="padding-left:110px;">
                        <div class="text-s text-custom1 text-uppercase mb-1">
                            <button id="btnGenerate" tabindex="10" onclick="btnGenerateClick()" class="btn btn-dark col-xl-5 text-center">処理実行</button>
                            &nbsp;&nbsp;&nbsp;&nbsp;
                            @*<button id="btnCancel" tabindex="11" onclick="btnCancelClick()" class="btn btn-primary col-xl-5 text-center">戻る</button>*@
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xs-12 col-md-3"></div>
        </div>
        <div class="col-md-12">
            <table id="tblExcel" style="display:none;">
                <thead><tr></tr></thead>
                <tbody></tbody>
            </table>
            <a id="dlink" style="display:none;"></a>
        </div>
    </div>
</div>
@section Scripts{
    <script type="text/javascript">
        $(document).ready(function () {
            $("#formtitle").text("原価集計表");
            $("#targetyear").attr('disabled', 'disabled');
            $("#BrandCD").focus();
            var Mode = '@Model.Mode';
            if (Mode == 'New') {
               // $('#btnGenerate').html('登録');

                @*RequiredCheck($("#targetyear"));
                DoubleByteCheck($("#targetyear"), '@Url.Action("DoubleByte_Checking", "api/CommonApi")');
                YearCheck($("#targetyear"), '@Url.Action("Year_Checking", "api/CommonApi")');*@

                //RequiredCheck($("#BrandCD"));
                DoubleByteCheck($("#BrandCD"), '@Url.Action("DoubleByte_Checking", "api/CommonApi")');
                ExistsCheck($("#BrandCD"), "Brand", '@Url.Action("M_Brand_ExistsCheck", "api/Print_GenkaApi")', "brandname");

                //RequiredCheck($("#projectCD"));
                DoubleByteCheck($("#ProjectCD"), '@Url.Action("DoubleByte_Checking", "api/CommonApi")');
                ExistsCheck($("#ProjectCD"), "Project", '@Url.Action("M_Project_ExistsCheck", "api/Print_GenkaApi")', "projectName");

                ShowTargetYear();
            }
        });

        function ShowTargetYear() {
            var Pmodel = {
                TargetYear: $("#targetyear").val(),
            };

            var data = CalltoApiController('@Url.Action("M_Contrl_Year_ExitCheck", "api/Print_GenkaApi")', Pmodel);
            var controldata = JSON.parse(data);
            //alert(controldata[0].FiscalYear);
            if (controldata[0].FiscalYear)
                $("#targetyear").val(controldata[0].FiscalYear);
            else
                ShowErrorMessage("E101");
        }

        function BrandCheck(result) {    // Make bold to BrandName after databind
            if (result == 'OK') {
                $("#brandname").css("font-weight", "Bold");
            }
            else $("#brandname").text('ブランド表示');
            $("#brandname").css("font-weight", "Bold");
        }

        function SeasonCheck(result) {
            if (result == 'OK') {
                var allyear = $("#allyear").is(":checked");
                var ss = $("#SS").is(":checked");
                var fw = $("#FW").is(":checked");
                if (!allyear && !ss && !fw) {
                    $("#FW").focus();
                    ShowErrorMessage("E111");
                }
            }
        }

        function flgCheck(result) {
            if (result == 'OK') {
                if (!$("#deliver").is(":checked") && !$("#undeliver").is(":checked")) {
                    $("#undeliver").focus();
                    ShowErrorMessage("E111");
                }
            }
        }

        function btnGenerateClick() {
            var allyear = $("#allyear").is(":checked");
            var ss = $("#SS").is(":checked");
            var fw = $("#FW").is(":checked");
            if (!allyear && !ss && !fw) {
                $("#FW").focus();
                var data = ShowErrorMessage("E111");
                return data;
            }
            else if (!$("#deliver").is(":checked") && !$("#undeliver").is(":checked")) {
                $("#undeliver").focus();
                ShowErrorMessage("E111");
            }
            else {
                var res = ErrorCheckOnSave();

                if (res == "0") {
                    var pmodel = {
                        TargetYear: $("#targetyear").val(),
                        BrandCD: $("#BrandCD").val(),
                        BrandName: $("#brandname").text(),
                        ProjectCD: $("#ProjectCD").val(),
                        ProjectName: $("#projectName").val(),
                        LoginID: '@LoginID'
                    };
                    var selected = new Array();
                    $("#Seasongp input[type=checkbox]:checked").each(function () {
                        selected.push(this.value);
                    });
                    if (selected.length > 0)
                        pmodel.Season = selected.join(",");

                    if ($('#deliver').is(':checked'))
                        pmodel.DeliveryStatus = "1";
                    else if ($('#undeliver').is(':checked'))
                        pmodel.DeliveryStatus = "2";

                    var data = CalltoApiController('@Url.Action("Print_GenkaCSV", "api/Print_GenkaApi")', pmodel);
                    var csv = JSON2CSV(data);
                    var downloadLink = document.createElement("a");
                    var blob = new Blob(["\ufeff", csv]);
                    var url = URL.createObjectURL(blob);
                    downloadLink.href = url;
                    downloadLink.download = "原価集計表.csv";

                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    Swal.fire({
                        icon: 'success',
                        title: 'I204',
                        text: 'EXCEL出力が完了しました',
                    })
                    ShowTargetYear();
                    $("#BrandCD").val('');
                    $("#brandname").text('ブランド表示');
                    $("#brandname").css("font-weight", "Bold");
                    $('#allyear').prop('checked', true);
                    $('#SS').prop('checked', false);
                    $('#FW').prop('checked', false);
                    $("#ProjectCD").val('');
                    $("#projectName").val('');
                    $('#deliver').prop('checked', true);
                    $('#undeliver').prop('checked', false);

                }
                else {
                    $("#BrandCD").focus();
                    ShowErrorMessage(res);
                }
            }
            download();
        }


        //Convert Jsonstring to csv
        function JSON2CSV(objArray) {
            var fiscalMM;
            var i, result = [];
            var array = typeof JSONString != 'object' ? JSON.parse(objArray) : JSONString;
            //var fields = Object.keys(array[0])
            var col_name = [ "", "", "処理年月に｢★｣印を出力→", "前期発生金額", "1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月", "当期配賦金額", "費目合計", "当期仕掛金額" ]
            var replacer = function (key, value) { return value === null ? '' : value }
            //var csv = array.map(function (row) {
            //    return fields.map(function (fieldName) {
            //        return JSON.stringify(row[fieldName], replacer)
            //    }).join(',')
            //})

            for (i = 0; i < array.length; i++) {
                if (array[i]["SortKey"] == '10') {
                    fiscalMM = array[i]["FiscalMM"];
                    result.push(JSON.stringify(array[i]["BrandCD"], replacer) + ',' + JSON.stringify(array[i]["Casting"], replacer) + ',' + JSON.stringify(array[i]["CostName"], replacer) + ',' + JSON.stringify(array[i]["CostPre"], replacer) + ',' +
                        JSON.stringify(array[i]["Cost1"], replacer) + ',' + JSON.stringify(array[i]["Cost2"], replacer) + ',' + JSON.stringify(array[i]["Cost3"], replacer) + ',' + JSON.stringify(array[i]["Cost4"], replacer) + ',' +
                        JSON.stringify(array[i]["Cost5"], replacer) + ',' + JSON.stringify(array[i]["Cost6"], replacer) + ',' + JSON.stringify(array[i]["Cost7"], replacer) + ',' + JSON.stringify(array[i]["Cost8"], replacer) + ',' +
                        JSON.stringify(array[i]["Cost9"], replacer) + ',' + JSON.stringify(array[i]["Cost10"], replacer) + ',' + JSON.stringify(array[i]["Cost11"], replacer) + ',' + JSON.stringify(array[i]["Cost12"], replacer) + ',' +
                        JSON.stringify(array[i]["CostHaihu"], replacer) + ',' + JSON.stringify(array[i]["Total"], replacer) + ',' + JSON.stringify(array[i]["CostShikakari"], replacer));
                }
                else if (array[i]["SortKey"] == '11') {
                    result.push(JSON.stringify(array[i]["BrandCD"], replacer) + ',' + JSON.stringify(array[i]["Casting"], replacer) + ',' + JSON.stringify(array[i]["CostName"], replacer) + ',' + JSON.stringify(array[i]["CostPre"], replacer) + ',' +
                        JSON.stringify(array[i]["Cost1"], replacer) + ',' + JSON.stringify(array[i]["Cost2"], replacer) + ',' + JSON.stringify(array[i]["Cost3"], replacer) + ',' + JSON.stringify(array[i]["Cost4"], replacer) + ',' +
                        JSON.stringify(array[i]["Cost5"], replacer) + ',' + JSON.stringify(array[i]["Cost6"], replacer) + ',' + JSON.stringify(array[i]["Cost7"], replacer) + ',' + JSON.stringify(array[i]["Cost8"], replacer) + ',' +
                        JSON.stringify(array[i]["Cost9"], replacer) + ',' + JSON.stringify(array[i]["Cost10"], replacer) + ',' + JSON.stringify(array[i]["Cost11"], replacer) + ',' + JSON.stringify(array[i]["Cost12"], replacer) + ',' +
                        JSON.stringify(array[i]["CostHaihu"], replacer) + ',' + JSON.stringify(array[i]["Total"], replacer) + ',' + JSON.stringify(array[i]["CostShikakari"], replacer));
                }
                else if (array[i]["SortKey"] == '20') {
                    result.push(JSON.stringify(array[i]["BrandCD"], replacer) + ',' + JSON.stringify(array[i]["Casting"], replacer) + ',' + JSON.stringify(array[i]["CostName"], replacer) + ',' + JSON.stringify(array[i]["CostPre"], replacer) + ',' +
                        JSON.stringify(array[i]["Cost1"], replacer) + ',' + JSON.stringify(array[i]["Cost2"], replacer) + ',' + JSON.stringify(array[i]["Cost3"], replacer) + ',' + JSON.stringify(array[i]["Cost4"], replacer) + ',' +
                        JSON.stringify(array[i]["Cost5"], replacer) + ',' + JSON.stringify(array[i]["Cost6"], replacer) + ',' + JSON.stringify(array[i]["Cost7"], replacer) + ',' + JSON.stringify(array[i]["Cost8"], replacer) + ',' +
                        JSON.stringify(array[i]["Cost9"], replacer) + ',' + JSON.stringify(array[i]["Cost10"], replacer) + ',' + JSON.stringify(array[i]["Cost11"], replacer) + ',' + JSON.stringify(array[i]["Cost12"], replacer) + ',' +
                        JSON.stringify(array[i]["CostHaihu"], replacer) + ',' + JSON.stringify(array[i]["Total"], replacer) + ',' + JSON.stringify(array[i]["CostShikakari"], replacer));
                }
                else if (array[i]["SortKey"] == '21') {
                    result.push(JSON.stringify(array[i]["BrandCD"], replacer) + ',' + JSON.stringify(array[i]["Casting"], replacer) + ',' + JSON.stringify(array[i]["CostName"], replacer) + ',' + JSON.stringify(array[i]["CostPre"], replacer) + ',' +
                        JSON.stringify(array[i]["Cost1"], replacer) + ',' + JSON.stringify(array[i]["Cost2"], replacer) + ',' + JSON.stringify(array[i]["Cost3"], replacer) + ',' + JSON.stringify(array[i]["Cost4"], replacer) + ',' +
                        JSON.stringify(array[i]["Cost5"], replacer) + ',' + JSON.stringify(array[i]["Cost6"], replacer) + ',' + JSON.stringify(array[i]["Cost7"], replacer) + ',' + JSON.stringify(array[i]["Cost8"], replacer) + ',' +
                        JSON.stringify(array[i]["Cost9"], replacer) + ',' + JSON.stringify(array[i]["Cost10"], replacer) + ',' + JSON.stringify(array[i]["Cost11"], replacer) + ',' + JSON.stringify(array[i]["Cost12"], replacer) + ',' +
                        JSON.stringify(array[i]["CostHaihu"], replacer) + ',' + JSON.stringify(array[i]["Total"], replacer) + ',' + JSON.stringify(array[i]["CostShikakari"], replacer));
                }
                else if (array[i]["SortKey"] == '30') {
                    var rowcount = 1, col2, j;
                    var pmodel = {
                        ProjectCD: array[i]["ProjectCD"],
                        LoginID: '@LoginID'
                    };
                    var data = CalltoApiController('@Url.Action("Print_Genka_ProjectData", "api/Print_GenkaApi")', pmodel);
                    var prj_array = typeof JSONString != 'object' ? JSON.parse(data) : JSONString;
                    for (j = 0; j < prj_array.length; j++) {
                        if (prj_array[j]["SortKey"] == '30') {
                            switch (rowcount) {
                                case 1: col2 = JSON.stringify(prj_array[j]["ProjectCD"], replacer) + '  ' + JSON.stringify(prj_array[j]["ProjectName"], replacer);
                                    break;
                                case 2: col2 = JSON.stringify(prj_array[j]["PeriodStart"], replacer) + ' ～ ' + JSON.stringify(prj_array[j]["PeriodEnd"], replacer);
                                    break;
                                case 3: col2 = '総金額' + '  ' + JSON.stringify(prj_array[j]["ProductionSum"], replacer);
                                    break;
                                case 4: col2 = '総生産数' + '  ' + JSON.stringify(prj_array[j]["TotalValueSum"], replacer);
                                    break;
                            }
                            rowcount = rowcount + 1;
                            result.push(JSON.stringify(null, replacer) + ',' + col2 + ',' + JSON.stringify(prj_array[j]["CostName"], replacer) + ',' + JSON.stringify(prj_array[j]["CostPre"], replacer) + ',' +
                                JSON.stringify(prj_array[j]["Cost1"], replacer) + ',' + JSON.stringify(prj_array[j]["Cost2"], replacer) + ',' + JSON.stringify(prj_array[j]["Cost3"], replacer) + ',' + JSON.stringify(prj_array[j]["Cost4"], replacer) + ',' +
                                JSON.stringify(prj_array[j]["Cost5"], replacer) + ',' + JSON.stringify(prj_array[j]["Cost6"], replacer) + ',' + JSON.stringify(prj_array[j]["Cost7"], replacer) + ',' + JSON.stringify(prj_array[j]["Cost8"], replacer) + ',' +
                                JSON.stringify(prj_array[j]["Cost9"], replacer) + ',' + JSON.stringify(prj_array[j]["Cost10"], replacer) + ',' + JSON.stringify(prj_array[j]["Cost11"], replacer) + ',' + JSON.stringify(prj_array[j]["Cost12"], replacer) + ',' +
                                JSON.stringify(prj_array[j]["CostHaihu"], replacer) + ',' + JSON.stringify(prj_array[j]["Total"], replacer) + ',' + JSON.stringify(prj_array[j]["CostShikakari"], replacer));
                        }
                    }
                }
            }

            fiscalMM = array[0]["FiscalMM"];
            var colname = ["処理年月に｢★｣印を出力→", "前期発生金額", "1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月", "当期配賦金額", "費目合計", "当期仕掛金額"]
            for (var i = 0; i <= colname.length - 1; i++) {
                if (i == 0) {
                    $('#tblExcel tr').append($("<th colspan='3' style = 'font-weight: bold;color: white;background-color: #000099'>"));
                }
                else {
                    $('#tblExcel tr').append($("<th style = 'font-weight: bold;color: white;background-color: #000099'>"));
                }

                if (colname[i].slice(0, -1) == fiscalMM) {
                    $('#tblExcel thead tr>th:last').html("｢★　" + colname[i] + "　★｣");
                }
                else {
                    $('#tblExcel thead tr>th:last').html(colname[i]);
                }
            }

            var add_row, a_row = 0, o_row = 0;
            debugger;
            for (i = 0; i < array.length; i++) {
                if (array[i]["SortKey"] == '10') {
                    if (a_row == 0) {
                        add_row = '<td rowspan = ' + array[i]["Row_Count"] + ' style="text-align: center; vertical-align: middle;">' + JSON.stringify(array[i]["BrandCD"], replacer) + '</td><td>' + JSON.stringify(array[i]["Casting"], replacer) + '</td><td>' + JSON.stringify(array[i]["CostName"], replacer) + '</td><td>' + JSON.stringify(array[i]["CostPre"], replacer) + '</td><td>' +
                            JSON.stringify(array[i]["Cost1"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost2"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost3"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost4"], replacer) + '</td><td>' +
                            JSON.stringify(array[i]["Cost5"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost6"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost7"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost8"], replacer) + '</td><td>' +
                            JSON.stringify(array[i]["Cost9"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost10"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost11"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost12"], replacer) + '</td><td>' +
                            JSON.stringify(array[i]["CostHaihu"], replacer) + '</td><td>' + JSON.stringify(array[i]["Total"], replacer) + '</td><td>' + JSON.stringify(array[i]["CostShikakari"], replacer) + '</td>';
                    }
                    else {
                        add_row = '<td>' + JSON.stringify(array[i]["Casting"], replacer) + '</td><td>' + JSON.stringify(array[i]["CostName"], replacer) + '</td><td>' + JSON.stringify(array[i]["CostPre"], replacer) + '</td><td>' +
                            JSON.stringify(array[i]["Cost1"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost2"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost3"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost4"], replacer) + '</td><td>' +
                            JSON.stringify(array[i]["Cost5"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost6"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost7"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost8"], replacer) + '</td><td>' +
                            JSON.stringify(array[i]["Cost9"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost10"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost11"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost12"], replacer) + '</td><td>' +
                            JSON.stringify(array[i]["CostHaihu"], replacer) + '</td><td>' + JSON.stringify(array[i]["Total"], replacer) + '</td><td>' + JSON.stringify(array[i]["CostShikakari"], replacer) + '</td>';
                    }
                    a_row = 1;
                    $('#tblExcel tbody').append($('<tr>'));
                    $('#tblExcel tbody tr:last').append(add_row);
                }
                else if (array[i]["SortKey"] == '11') {
                    add_row = '<td>' + JSON.stringify(array[i]["Casting"], replacer) + '</td><td>' + JSON.stringify(array[i]["CostName"], replacer) + '</td><td>' + JSON.stringify(array[i]["CostPre"], replacer) + '</td><td>' +
                        JSON.stringify(array[i]["Cost1"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost2"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost3"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost4"], replacer) + '</td><td>,' +
                        JSON.stringify(array[i]["Cost5"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost6"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost7"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost8"], replacer) + '</td><td>' +
                        JSON.stringify(array[i]["Cost9"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost10"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost11"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost12"], replacer) + '</td><td>' +
                        JSON.stringify(array[i]["CostHaihu"], replacer) + '</td><td>' + JSON.stringify(array[i]["Total"], replacer) + '</td><td>' + JSON.stringify(array[i]["CostShikakari"], replacer) + '</td>';
                    $('#tblExcel tbody').append($('<tr style="border - top: 2px solid; border - bottom: 2px solid">'));
                    $('#tblExcel tbody tr:last').append(add_row);
                }
                else if (array[i]["SortKey"] == '20') {
                    if (o_row == 0) {
                        add_row = '<td rowspan = ' + array[i]["Row_Count"] + ' style="text-align: center;background-color: blue; vertical-align: middle;">' + JSON.stringify(array[i]["BrandCD"], replacer) + '</td><td style="background-color: blue"></td><td>' + JSON.stringify(array[i]["CostName"], replacer) + '</td><td>' +
                            JSON.stringify(array[i]["CostPre"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost1"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost2"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost3"], replacer) + '</td><td>' +
                            JSON.stringify(array[i]["Cost4"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost5"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost6"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost7"], replacer) + '</td><td>' +
                            JSON.stringify(array[i]["Cost8"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost9"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost10"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost11"], replacer) + '</td><td>' +
                            JSON.stringify(array[i]["Cost12"], replacer) + '</td><td>' + JSON.stringify(array[i]["CostHaihu"], replacer) + '</td><td>' + JSON.stringify(array[i]["Total"], replacer) + '</td><td>' + JSON.stringify(array[i]["CostShikakari"], replacer) + '</td>';
                    }
                    else {
                        add_row = '<td style="background-color: blue"></td><td>' + JSON.stringify(array[i]["CostName"], replacer) + '</td><td>' + JSON.stringify(array[i]["CostPre"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost1"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost2"], replacer) + '</td><td>' +
                            JSON.stringify(array[i]["Cost3"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost4"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost5"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost6"], replacer) + '</td><td>' +
                            JSON.stringify(array[i]["Cost7"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost8"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost9"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost10"], replacer) + '</td><td>' +
                            JSON.stringify(array[i]["Cost11"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost12"], replacer) + '</td><td>' + JSON.stringify(array[i]["CostHaihu"], replacer) + '</td><td>' + JSON.stringify(array[i]["Total"], replacer) + '</td><td>' + JSON.stringify(array[i]["CostShikakari"], replacer) + '</td>';
                    }
                    o_row = 1;
                    $('#tblExcel tbody').append($('<tr>'));
                    $('#tblExcel tbody tr:last').append(add_row);
                }
                else if (array[i]["SortKey"] == '21') {
                    add_row = '<td style="background-color: blue"></td><td>' + JSON.stringify(array[i]["CostName"], replacer) + '</td><td>' + JSON.stringify(array[i]["CostPre"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost1"], replacer) + '</td><td>' +
                        JSON.stringify(array[i]["Cost2"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost3"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost4"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost5"], replacer) + '</td><td>' +
                        JSON.stringify(array[i]["Cost6"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost7"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost8"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost9"], replacer) + '</td><td>' +
                        JSON.stringify(array[i]["Cost10"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost11"], replacer) + '</td><td>' + JSON.stringify(array[i]["Cost12"], replacer) + '</td><td>' +
                        JSON.stringify(array[i]["CostHaihu"], replacer) + '</td><td>' + JSON.stringify(array[i]["Total"], replacer) + '</td><td>' + JSON.stringify(array[i]["CostShikakari"], replacer) + '</td>';
                    $('#tblExcel tbody').append($('<tr style="border - top: 2px solid; border - bottom: 2px solid">'));
                    $('#tblExcel tbody tr:last').append(add_row);
                }
                else if (array[i]["SortKey"] == '30') {
                    var rowcount = 1, col2, j;
                    var pmodel = {
                        ProjectCD: array[i]["ProjectCD"],
                        LoginID: '@LoginID'
                    };
                    var data = CalltoApiController('@Url.Action("Print_Genka_ProjectData", "api/Print_GenkaApi")', pmodel);
                    var prj_array = typeof JSONString != 'object' ? JSON.parse(data) : JSONString;
                    for (j = 0; j < prj_array.length; j++) {
                        if (prj_array[j]["SortKey"] == '30') {
                            switch (rowcount) {
                                case 1: col2 = JSON.stringify(prj_array[j]["ProjectCD"], replacer) + '  ' + JSON.stringify(prj_array[j]["ProjectName"], replacer);
                                    break;
                                case 2: col2 = JSON.stringify(prj_array[j]["PeriodStart"], replacer) + ' ～ ' + JSON.stringify(prj_array[j]["PeriodEnd"], replacer);
                                    break;
                                case 3: col2 = '総金額' + '  ' + JSON.stringify(prj_array[j]["ProductionSum"], replacer);
                                    break;
                                case 4: col2 = '総生産数' + '  ' + JSON.stringify(prj_array[j]["TotalValueSum"], replacer);
                                    break;
                            }
                            rowcount = rowcount + 1;
                            add_row = '<td>' + col2 + '</td><td>' + JSON.stringify(prj_array[j]["CostName"], replacer) + '</td><td>' + JSON.stringify(prj_array[j]["CostPre"], replacer) + '</td><td>' +
                                JSON.stringify(prj_array[j]["Cost1"], replacer) + '</td><td>' + JSON.stringify(prj_array[j]["Cost2"], replacer) + '</td><td>' + JSON.stringify(prj_array[j]["Cost3"], replacer) + '</td><td>' + JSON.stringify(prj_array[j]["Cost4"], replacer) + '</td><td>' +
                                JSON.stringify(prj_array[j]["Cost5"], replacer) + '</td><td>' + JSON.stringify(prj_array[j]["Cost6"], replacer) + '</td><td>' + JSON.stringify(prj_array[j]["Cost7"], replacer) + '</td><td>' + JSON.stringify(prj_array[j]["Cost8"], replacer) + '</td><td>' +
                                JSON.stringify(prj_array[j]["Cost9"], replacer) + '</td><td>' + JSON.stringify(prj_array[j]["Cost10"], replacer) + '</td><td>' + JSON.stringify(prj_array[j]["Cost11"], replacer) + '</td><td>' + JSON.stringify(prj_array[j]["Cost12"], replacer) + '</td><td>' +
                                JSON.stringify(prj_array[j]["CostHaihu"], replacer) + '</td><td>' + JSON.stringify(prj_array[j]["Total"], replacer) + '</td><td>' + JSON.stringify(prj_array[j]["CostShikakari"], replacer) + '</td>';
                        }
                        $('#tblExcel tbody').append($('<tr>'));
                        $('#tblExcel tbody tr:last').append(add_row);
                    }
                }
            }

            //csv.unshift(fields.join(',')) // add header column
            //csv = csv.join('\r\n');

            result.unshift(col_name.join(',')) // add header column
            result = result.join('\r\n');
            return result;
        }

        $('#btnGenerate').keydown(function (e) {
            var code = e.keyCode || e.which;
            if (code == 9) {
                if (e.shiftKey) {
                    //Focus previous input
                    if (thisTab == startIndex) {
                        $("." + tabLimitInID).find('[tabindex=' + lastIndex + ']').focus();
                        return false;
                    }
                    else {
                        e.preventDefault();
                    }
                }
                e.preventDefault();
            }
        });

        //Excel Print//
        var tableToExcel = (function () {
            var uri = 'data:application/vnd.ms-excel;base64,'
                , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><?xml version="1.0" encoding="UTF-8" standalone="yes"?><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
                , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
                , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
            return function (table, name, filename) {
                if (!table.nodeType) table = document.getElementById(table)
                var ctx = {
                    worksheet: name || 'Worksheet',
                    table: table.innerHTML
                }

                document.getElementById("dlink").href = uri + base64(format(template, ctx));
                document.getElementById("dlink").download = filename;
                document.getElementById("dlink").traget = "_blank";
                document.getElementById("dlink").click();
            }
        })();
        function download() {
            $(document).find('tfoot').remove();
            var name = '原価集計表.xls';
            tableToExcel('tblExcel', '原価集計表', name);
            $('#tblExcel tr th').remove();
            $('#tblExcel tr td').remove();
        }
        //Excel Print//
    </script>
}