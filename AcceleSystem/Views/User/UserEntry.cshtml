@model Models.UserModel
@{
    ViewBag.Title = "UserEntry";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section Styles{
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Content/bootstrap-textbox.css")" />   
}

<div class="container-fluid" >
    <div class="content">
        <div class="p-5 row shadow" style="box-shadow: 0 .1rem .4rem rgba(0,0,0,.1) !important; background:white;">
            <div class="col-xs-6 col-md-4"></div>
            <div class="col-xs-6 col-md-4">
                <div>
                    <h2 class=" hr-text text-center">ユーザー登録</h2>
                </div>
                <div class="pt-5 md-form">
                    @*<label for="lblUserName">User Name</label>*@
                    <input type="text" class="text-line" id="UserName" name="name" maxlength="40" required placeholder="ユーザー名">
                    @*<span id="errname" class="color-red"></span>*@
                </div>
                <div class="pt-5 md-form">
                    @*<label for="lblUserID">UserID</label>*@
                    <input type="text" class="text-line" id="UserID" name="id" maxlength="20" required placeholder="ID">
                    @*<span id="errid" class="color-red"></span>*@
                </div>
                <div class="pt-5 md-form">
                    @*<label for="lblPassword">Password</label>*@
                    <input type="password" class="text-line" id="Password" maxlength="10" name="pass" required placeholder="パスワード">
                    @*<span id="errpass" class="color-red"></span>*@
                </div>
                <div>
                    <span id="errexist" class="color-red"></span>
                </div>
                <div class="pt-5 md-form">
                    <div class="col-xl-12 text-center">
                        <div class="text-s text-custom1 text-uppercase mb-1">
                            <button id="btnSave" onclick="btnSaveClick()" class="btn btn-dark col-xl-5 text-center"></button>
                            &nbsp;&nbsp;&nbsp;&nbsp;
                            <button id="btnCancel" onclick="btnCancelClick()" class="btn btn-primary col-xl-5 text-center">戻る</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xs-6 col-md-4"></div>
        </div>
    </div>
</div>


@section Scripts{
    <script type="text/javascript">
        $(document).ready(function () {
            var Mode = '@Model.Mode';
            if (Mode == 'New') {
                $('#btnSave').html('登録');
            }
            else if (Mode == 'Edit') {
                $('#btnSave').html('更新');
                $("#UserID").prop("readonly", true);
                ShowData();
            }
            else {
                $('#btnSave').html('削除');
                $("#UserID").prop("readonly", true);
                $("#UserName").prop("readonly", true);
                $("#Password").prop("readonly", true);
                ShowData();
            }

        });

        //set data
        function ShowData() {
            var Umodel = {
                UserID: '@Model.UserID',
            };

            $.ajax({
                url: '@Url.Action("M_User_Select", "api/UserApi")',
                method: 'Post',
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(Umodel),
                headers:
                {
                    Authorization: 'Basic ' + btoa('Capital_MM' + ':' + 'CKM12345!')
                },
                success: function (data) {
                    var userdata = JSON.parse(data);
                    $("#UserID").val(userdata[0].ID);
                    $("#UserName").val(userdata[0].UserName);
                    $("#Password").val(userdata[0].Password);
                }
            });
        }

        //insert,update,delete
        function DoProcess() {
            var Umodel = {
                UserID: $("#UserID").val(),
                UserName: $("#UserName").val(),
                Password: $("#Password").val(),
                Mode:'@Model.Mode'
            };

             $.ajax({
                url: '@Url.Action("User_CUD", "api/UserApi")',
                method: 'POST',
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(Umodel),
                headers:
                {
                    Authorization: 'Basic ' + btoa('Capital_MM' + ':' + 'CKM12345!')
                },
                success: function (msg) {
                    var message = JSON.parse(msg);
                    Swal.fire(
                        message[0].MessageID,
                        message[0].MessageText1,
                        'success'
                    ).then(function () {
                        if(Umodel.Mode == "New")
                            location.href = '@Url.Action("UserEntry", "User")';
                        else
                            location.href = '@Url.Action("UserList", "User")';
                    });
                }
            });
        }

        //save
        function btnSaveClick() {
            var Mode = '@Model.Mode';
            //show confirm message
            if (Mode == "Delete") {
                Swal.fire({
                    title: 'Q102',
                    text: "削除します。よろしいですか？",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'はい。',
                    cancelButtonText: 'いいえ。'
                }).then((result) => {
                    if (result.value) {
                        DoProcess();
                    }
                })
            }
            else {
                DoProcess();
            }
        }
    function btnCancelClick() {
        window.location.replace('@Url.Action("UserList", "User")');
    }
    </script>
}

