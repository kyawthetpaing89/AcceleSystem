@model Models.KanagataModel

@{
    ViewBag.Title = "KanagataEntry";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles{
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Content/bootstrap-textbox.css")" />
    <link rel="stylesheet" type="text/css" href="@Url.Content("~/Content/datepicker.css")" />
}


<div class="container-fluid">
    <div class="content">
        <div class="p-5 row shadow" style="box-shadow: 0 .1rem .4rem rgba(0,0,0,.1) !important; background:white; border-radius:5px;">
            <div class="col-xs-6 col-md-4"></div>
            <div class="col-xs-6 col-md-4">
                <div>
                    <h2 class=" hr-text text-center">金型登録</h2>
                </div>
                <div class="pt-3 md-form">
                    <div class="col-xl-12 text-center">
                        <div class="text-s text-custom1 text-uppercase mb-1">
                            <input type="text" tabindex="1" class="text-line col-xl-5 text-left" onkeydown="KeyDown(event,this)" id="CastingCD" name="castingCD" maxlength="10" required placeholder="金型コード">
                            &nbsp;&nbsp;&nbsp;&nbsp;
                            <input type="text" tabindex="2" class="text-line col-xl-5 text-left" onkeydown="KeyDown(event,this)" id="CastingName" name="Name" maxlength="20" required placeholder="金型名">
                        </div>
                    </div>
                </div>
                <div class="pt-3 md-form">
                    <div class="col-xl-12 text-center">
                        <div class="text-s text-custom1 text-uppercase mb-1">
                            <input type="text" tabindex="3" class="text-line col-xl-5 text-left" id="BrandCD" onkeydown="KeyDown(event,this)" name="brandCD" maxlength="20" required placeholder="ブランドコード">
                            &nbsp;&nbsp;&nbsp;&nbsp;
                            <input type="text" class="text-line col-xl-5 text-left" id="BrandName" name="brandname" maxlength="40" required placeholder="ブランド名">
                            @*<input type="text" class="text-line col-11" id="BrandName" name="brandname" style="width:91%" required placeholder="ブランド名">*@
                        </div>
                    </div>
                </div>
                <div class="pt-3 md-form">
                    <div class="col-xl-12 text-center">
                        <input type="text" tabindex="4" class="text-line col-11 datepicker-here" id="UseLimit" name="Limit" style="width:91%"  required placeholder="使用期限">
                    </div>

                </div>
                <div>
                    <span id="errexist" class="color-red"></span>
                </div>
                <div class="pt-3 md-form">
                    <div class="col-xl-12 text-center">
                        <div class="text-s text-custom1 text-uppercase mb-1">
                            <button id="btnSave" tabindex="6" onclick="btnSaveClick()" class="btn btn-dark col-xl-5 text-center"></button>
                            &nbsp;&nbsp;&nbsp;&nbsp;
                            <button id="btnCancel" onclick="btnCancelClick()" class="btn btn-primary col-xl-5 text-center">戻る</button>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="APIURL" value="@Url.Action("M_Casting_ExistsCheck", "api/KanagataApi")" />
            </div>
            <div class="col-xs-6 col-md-4"></div>
        </div>
    </div>
</div>


@section Scripts{
    <script type="text/javascript">
        $(document).ready(function () {
            $("#formtitle").text("金型登録");
            $("#BrandName").attr('disabled', 'disabled');
            $("#CastingCD").focus();
            var Mode = '@Model.Mode';
            if (Mode == 'New') {
                $('#btnSave').html('登録');
                $("#BrandName").attr('disabled', 'disabled');

                RequiredCheck($("#CastingCD"));
                RequiredCheck($("#CastingName"));
                RequiredCheck($("#BrandCD"));
                ExistsCheck($("#BrandCD"), "Brand", '@Url.Action("M_Brand_ExistsCheck", "api/BrandApi")', "BrandName");
                AlreadyExistsCheck($("#CastingCD"), "Casting", '@Url.Action("M_Casting_ExistsCheck", "api/KanagataApi")');
            }
            else if (Mode == 'Edit') {
                $('#btnSave').html('更新');
                $("#CastingCD").attr('disabled', 'disabled');
                $("#CastingName").focus();
                $("#BrandName").attr('disabled', 'disabled');
                

                RequiredCheck($("#CastingCD"));
                RequiredCheck($("#CastingName"));
                RequiredCheck($("#BrandCD")); 
                ExistsCheck($("#BrandCD"), "Brand", '@Url.Action("M_Brand_ExistsCheck", "api/BrandApi")', "BrandName");

                ShowData();
            }
            else  {
                $('#btnSave').html('削除');
                $("#CastingCD").attr('disabled', 'disabled');
                $("#CastingName").attr('disabled', 'disabled');
                $("#BrandCD").attr('disabled', 'disabled');
                $("#BrandName").attr('disabled', 'disabled');
                $("#UseLimit").attr('disabled', 'disabled');
                $("#btnSave").focus();
                ShowData();
            }            
        });

      

        @*function CheckDate() {
            if (!($('#UseLimit').val() == '')) {
                var inputdate = $("#UseLimit").val();

                $.ajax({
                    url: '@Url.Action("Date_Checking", "api/CommonApi")',
                    method: 'Post',
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(inputdate),
                    headers:
                    {
                        Authorization: 'Basic ' + btoa('Capital_MM' + ':' + 'CKM12345!')
                    },
                    success: function (data) {
                        var dateData = JSON.parse(data);
                        if (dateData.length > 0) {
                            if (dateData[0].flg == "false") {
                                $.when(GetMessage("E103", '@Url.Action("M_Message_Select", "api/MessageApi")')).done(function (data) {
                                    var msgdata = JSON.parse(data);
                                    Swal.fire({
                                        icon: 'error',
                                        title: msgdata[0].MessageID,
                                        text: msgdata[0].MessageText1,
                                    }).then(function () {
                                        $("#UseLimit").focus();
                                    });
                                })
                            }
                            else if (dateData[0].flg == "true") {
                                $("#UseLimit").val(dateData[0].resultdate);
                                $("#btnSave").focus();
                            }
                        }
                    }
                });
            }
            else 
                $("#btnSave").focus();
        }*@

        //set data
        function ShowData() {
            var kgmodel = {
                CastingCD: '@Model.CastingCD',
            };

            $.ajax({
                url: '@Url.Action("M_Casting_Select", "api/KanagataApi")',
                method: 'Post',
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(kgmodel),
                headers:
                {
                    Authorization: 'Basic ' + btoa('Capital_MM' + ':' + 'CKM12345!')
                },
                success: function (data) {
                    var userdata = JSON.parse(data);
                    $("#CastingCD").val(userdata[0].CastingCD);
                    $("#CastingName").val(userdata[0].CastingName);
                    $("#BrandCD").val(userdata[0].BrandCD);
                    $("#BrandName").val(userdata[0].BrandName);
                    $("#UseLimit").val(userdata[0].UseLimit);
                }
            });
        }

        function DoProcess() {
            focusControl = $("#CastingCD");
             var kgmodel = {
                 CastingCD: $("#CastingCD").val(),
                 CastingName: $("#CastingName").val(),
                 BrandCD: $("#BrandCD").val(),
                 BrandName: $("#BrandName").val(),
                 UseLimit: $("#UseLimit").val(),
                 Mode:'@Model.Mode'
            };

             $.ajax({
                url: '@Url.Action("Casting_CUD", "api/KanagataApi")',
                method: 'POST',
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                 data: JSON.stringify(kgmodel),
                headers:
                {
                    Authorization: 'Basic ' + btoa('Capital_MM' + ':' + 'CKM12345!')
                },
                 success: function (msg) {
                     var message = JSON.parse(msg);
                     Swal.fire({
                         icon: message[0].status,
                         title: message[0].MessageID,
                         text: message[0].MessageText1,
                     }).then(function () {
                         if (message[0].status != "error")
                             //location.href = '@Url.Action("UserEntry", "User")';
                         //else
                             location.href = '@Url.Action("KanagataList", "Kanagata")';
                     });
                 }
            });
        }


        //var focusControl;
        //function ErrorCheck() {
        //    if (!$("#CastingCD").val()) {
        //        focusControl = $("#CastingCD");
        //        return "I102";
        //    }
        //    else if (!$("#CastingName").val()) {
        //        focusControl = $("#CastingName");
        //        return "I102";
        //    }
        //    return "0";
        //}


        //save
        function btnSaveClick() {
            var msgID = ErrorCheck();
            if (msgID == "0") {
                var Mode = '@Model.Mode';
                //show confirm message
                if (Mode == "Delete") {
                    $.when(GetMessage("Q102", '@Url.Action("M_Message_Select", "api/MessageApi")')).done(function (data) {
                        var msgdata = JSON.parse(data);
                        Swal.fire({
                            title: msgdata[0].MessageID,
                            text: msgdata[0].MessageText1,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#3085d6',
                            confirmButtonText: 'はい。',
                            cancelButtonText: 'いいえ。'
                        }).then((result) => {
                            if (result.value) {
                                DoProcess();
                            }
                        })
                    })
                }
                else {
                    DoProcess();
                }
            }
            else {
                $.when(GetMessage("E102", '@Url.Action("M_Message_Select", "api/MessageApi")')).done(function (data) {
                    var msgdata = JSON.parse(data);

                    Swal.fire({
                        icon: 'error',
                        title: msgdata[0].MessageID,
                        text: msgdata[0].MessageText1,
                    }).then(function () {

                     });
                })
                $(focusControl).focus();
            }
        }

        function btnCancelClick() {
            location.href = '@Url.Action("KanagataList", "Kanagata")';
        }


    </script>
    <script src="@Url.Content("~/Scripts/datepicker.js")"></script>
    <script src="@Url.Content("~/Scripts/datepicker.en.js")"></script>
    @*<script src="@Url.Content("~/Scripts/datepicker.ja.js")"></script>*@
}

